name: update-hosts

on: 
  schedule:
    - cron: "10 1/8 * * *"
  workflow_dispatch:

jobs:
  hosts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Init Env
        run : |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"
          python -m pip install --upgrade pip
          python -m pip install requests requests-html retry
          
      - name: Get Github Hosts
        shell: python
        run: |
          import os
          import time
          import re
          from retry import retry
          from requests_html import HTMLSession
          from typing import Any, Optional

          # 1. 还原 get_best_ip：原项目其实是取列表第一个有效值
          def get_best_ip(ip_list: list) -> Optional[str]:
              if not ip_list:
                  return None
              for ip in ip_list:
                  if ip.startswith("127.") or ip.startswith("0."):
                      continue
                  return ip
              return None

          # 2. 深度还原原项目的 get_ip 逻辑
          @retry(tries=3, delay=2)
          def get_ip(session: Any, github_url: str) -> Optional[str]:
              # 关键点：原项目对于不同的域名后缀，URL 构造逻辑其实有细微差别
              # 这里采用它最核心的解析地址
              url = f'https://sites.ipaddress.com/{github_url}'
              headers = {
                  'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36'
              }
              try:
                  rs = session.get(url, headers=headers, timeout=10)
                  # 核心区别：原项目使用 requests-html 的 .html.text
                  # 这样可以获取到 JS 渲染后或者隐藏在标签里的文本
                  pattern = r"\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b"
                  
                  # 爬取逻辑：先找页面上所有的 IP
                  # 原项目在特定情况下会去解析 table 里的内容
                  ip_list = re.findall(pattern, rs.html.text)
                  
                  best_ip = get_best_ip(ip_list)
                  if best_ip:
                      return best_ip
                  else:
                      # 如果 sites 没找到，尝试二级跳转逻辑 (GitHub520 备选方案)
                      alt_url = f'https://{github_url}.ipaddress.com'
                      rs_alt = session.get(alt_url, headers=headers, timeout=10)
                      ip_list_alt = re.findall(pattern, rs_alt.html.text)
                      best_ip_alt = get_best_ip(ip_list_alt)
                      if best_ip_alt:
                          return best_ip_alt
                      raise Exception(f"url: {github_url}, ipaddress empty")
              except Exception as ex:
                  print(f"Error resolving {github_url}: {ex}")
                  raise ex

          if __name__ == '__main__':
              # 使用原项目推荐的 HTMLSession
              session = HTMLSession()
              
              gitHubDoMains = [
                  "alive.github.com", "api.github.com", "api.individual.githubcopilot.com",
                  "avatars.githubusercontent.com", "avatars0.githubusercontent.com",
                  "avatars1.githubusercontent.com", "avatars2.githubusercontent.com",
                  "avatars3.githubusercontent.com", "avatars4.githubusercontent.com",
                  "avatars5.githubusercontent.com", "camo.githubusercontent.com",
                  "central.github.com", "cloud.githubusercontent.com", "codeload.github.com",
                  "collector.github.com", "desktop.githubusercontent.com",
                  "favicons.githubusercontent.com", "gist.github.com",
                  "github-cloud.s3.amazonaws.com", "github-com.s3.amazonaws.com",
                  "github-production-release-asset-2e65be.s3.amazonaws.com",
                  "github-production-repository-file-5c1aeb.s3.amazonaws.com",
                  "github-production-user-asset-6210df.s3.amazonaws.com", "github.blog",
                  "github.com", "github.community", "github.githubassets.com",
                  "github.global.ssl.fastly.net", "github.io", "github.map.fastly.net",
                  "githubstatus.com", "live.github.com", "media.githubusercontent.com",
                  "objects.githubusercontent.com", "pipelines.actions.githubusercontent.com",
                  "raw.githubusercontent.com", "user-images.githubusercontent.com",
                  "vscode.dev", "education.github.com", "private-user-images.githubusercontent.com"
              ]
              
              dockerDoMains = ["hub.docker.com", "ghcr.io", "gcr.io", "k8s.gcr.io", "quay.io"]

              dnsList = []
              dnsList.append('# GitHub520 Hosts Start')
              dnsList.append(f'# Update at: {time.strftime("%Y-%m-%d %H:%M:%S")}')

              for label, domains in [("GitHub", gitHubDoMains), ("Docker", dockerDoMains)]:
                  dnsList.append(f'\n# {label} Hosts')
                  for domain in domains:
                      try:
                          ip = get_ip(session, domain)
                          if ip:
                              print(f"Resolved {domain} -> {ip}")
                              dnsList.append(f"{ip.ljust(16)} {domain}")
                          time.sleep(1.5)
                      except:
                          print(f"Failed to resolve {domain}")

              dnsList.append('\n# GitHub520 Hosts End')
              
              with open('hosts', 'w', encoding="utf-8") as f:
                  f.write('\n'.join(dnsList))

      - name: Check and Push
        run: |
          if [ -n "$(git status -s | grep hosts)" ]; then
            git add hosts
            git commit -m "update $(date +%Y-%m-%d" "%H:%M:%S)"
            git push -f
          fi
